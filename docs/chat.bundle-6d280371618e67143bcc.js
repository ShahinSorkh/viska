(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{13:function(e,t,n){"use strict";n.r(t);var i=n(19),o=n.n(i),r=n(32),s=n.n(r),a=n(49),c=n.n(a),u=n(29),f=n(77),h=n.n(f),g=n(79),l=n.n(g),d=n(81),m=function(e){var t=e.name,n=void 0===t?"db":t,i=e.version,o=void 0===i?1:i,r=e.prefix,a=void 0===r?"":r,c=e.dynamicCollections,u=void 0===c?[]:c,f=e.staticCollections,g=void 0===f?[]:f,m=[].concat(s()(u),s()(g)),p=function(e){return u.includes(e)},v=new Promise((function(e){Object(d.b)(n,o,{upgrade:function(e){return l()(h.a.mark((function t(){return h.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:m.forEach((function(t){e.objectStoreNames.contains(t)||e.createObjectStore(t)}));case 1:case"end":return t.stop()}}),t)})))()}}).then(e).catch((function(){e({get:function(e,t){var i=localStorage.getItem("".concat(n,"@").concat(o,":").concat(e,".").concat(t));return Promise.resolve(i?JSON.parse(i):void 0)},put:function(e,t,i){return localStorage.setItem("".concat(n,"@").concat(o,":").concat(e,".").concat(i),JSON.stringify(t)),Promise.resolve()},clear:function(e,t){return localStorage.removeItem("".concat(n,"@").concat(o,":").concat(e,".").concat(t)),Promise.resolve()}})}))})),b=function(e){var t=function(t){return v.then((function(n){return n.put(e,t,p(e)?a:"root")}))};return{get:function(){if("chats"===e&&a)return new Promise((function(n){var i,o;(i=a.substr(1),o=!0,new Promise((function(e){Object(d.b)("LokiCatalog",1).then((function(t){t.get("LokiAKV",1).then((function(t){var n=t.val?JSON.parse(t.val):{};if(n.filename.includes(i)&&n.collections&&n.collections.length){var r=n.collections[0].data.map((function(e){return{badge:e.badge,isOnline:null,messages:e.messages,user:e.user}}));e(r),o&&Object(d.a)("LokiCatalog")}})).catch((function(){return e([])}))})).catch((function(){return e([])}))}))).then((function(i){v.then((function(t){return t.get(e,p(e)?a:"root")})).then((function(e){var o=[].concat(s()(e||[]),s()(i)).filter((function(e,t,n){return n.findIndex((function(t){return t.user.username===e.user.username}))===t}));t(o).then((function(){n(o)}))}))}))}));v.then((function(t){return t.get(e,p(e)?a:"root")}))},set:t,clear:function(){return v.then((function(t){return t.clear(e,p(e)?a:"root")}))}}},y={};return m.forEach((function(e){y[e]=b(e)})),y};function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}var v=function(e,t){return{type:e,username:t}},b={data:function(){return{user:v(),sid:void 0,server:void 0,chats:[],db:null,_refreshChatsLoopTimeout:null}},methods:{init:function(e){this.server=c()(e,{autoConnect:!1}),this.server.on("connect",this._onConnectionStateChange.bind(this,!0)),this.server.on("disconnect",this._onConnectionStateChange.bind(this,!1)),this.server.on("newMessage",this._onNewMessage),this.server.on("isTypingFlag",this._onIsTypingFlag),this.server.on("connetedToRandomUser",this._onConnetedToRandomUser),this.server.open(),this.startRefreshChatsLoop()},login:function(e){var t=this;return new Promise((function(n,i){t.server.emit("auth",e,(function(e,o){e?i(e):(t.user=v(o.type,o.username),t.db=m({name:"viska",version:2,prefix:"temporary"===t.user.type?"!anonymous":"@".concat(t.user.username),dynamicCollections:["chats"],staticCollections:["settings"]}),t._loadChats().then((function(){t.$emit("login",o.type,o.username),setTimeout((function(){t.server.emit("askForPendingMessages",(function(){}))})),n()})))}))}))},logout:function(){var e=this;this._saveChats().then((function(){e.chats=[],e.user=v(),e.$emit("logout"),setTimeout((function(){location.reload()}),100)}))},connectToRandomUser:function(){var e=this;return new Promise((function(t,n){e.server.emit("connectToRandomUser",(function(i,o){i||!o?n(i):e.getChat(o.type,o.username).then((function(e){t(e)}))}))}))},cancelConnectToRandomUser:function(){var e=this;return new Promise((function(t){e.server.emit("cancelConnectToRandomUser",(function(e){t()}))}))},_onConnetedToRandomUser:function(e){var t=this,n=e.type,i=e.username;this.getChat(n,i).then((function(e){t.$emit("connetedToRandomUser",e)}))},addMessageToChat:function(e,t){e.messages.push(t);var n=this.chats.indexOf(e);return this.chats=[e].concat(s()(this.chats.slice(0,n)),s()(this.chats.slice(n+1))),this._saveChats()},editChat:function(e,t){return Object.keys(t).forEach((function(n){e[n]=t[n]})),this._saveChats()},sendMessage:function(e,t){var n=this;return new Promise((function(i,o){n.server.emit("sendMessage",{user:e.user,body:t},(function(t,r){t&&o(t),n.addMessageToChat(e,{from:"me",body:Object(u.b)(r.body),date:r.date}).then(i)}))}))},_onNewMessage:function(e){var t=this,n=e.from,i=n.type,o=n.username,r=e.body,s=e.date;this.getChat(i,o,!1).then((function(e){e.isOnline=!0,t.addMessageToChat(e,{from:"its",body:Object(u.b)(r),date:s}).then((function(){t.$emit("newMessage",{user:v(i,o),body:r,date:s})}))}))},sendIsTypingFlag:function(e){var t=this;return new Promise((function(n,i){t.server.emit("sendIsTypingFlag",{user:{type:e.user.type,username:e.user.username}},(function(e){e?i():n()}))}))},_onIsTypingFlag:function(e){this.$emit("isTypingFlag",e)},deleteChat:function(e){return this.chats.splice(this.chats.indexOf(e),1),this._saveChats()},refreshChat:function(e){var t=this;return new Promise((function(n){t.server.emit("getUserStatus",e.user,(function(t,i){e.isOnline=!t&&i,n(e.isOnline)}))}))},startRefreshChatsLoop:function(){var e=this;clearTimeout(this._refreshChatsLoopTimeout),this.chats.forEach((function(t){e.refreshChat(t)})),this._refreshChatsLoopTimeout=setTimeout((function(){e.startRefreshChatsLoop()}),1e4)},_saveChats:function(){var e=this;return new Promise((function(t){e.db?setTimeout((function(){var n=e.chats.map((function(t){return"temporary"===e.user.type?function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t,{messages:[]}):t}));e.db.chats.set(n).then(t)})):t()}))},_loadChats:function(){var e=this;return new Promise((function(t){e.db?e.db.chats.get().then((function(n){e.chats=(n||[]).map((function(e){return e.isOnline=null,e})),t(),e.startRefreshChatsLoop()})):(e.chats=[],t())}))},_clearChats:function(){this.chats=[]},_onConnectionStateChange:function(e){!0===e?(this.sid=this.server.id,this.$emit("connect",this.sid)):(location.reload(),this.$emit("disconnect"))},getChat:function(e,t){var n=this,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return new Promise((function(o){var r=n.chats.find((function(n){return n.user.type===e&&n.user.username===t}));r||(r={user:v(e,t),isOnline:null,messages:[],badge:0},n.chats.unshift(r)),i?n._saveChats().then((function(){o(r)})):o(r)}))}}};t.default=b},29:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));var i=n(30),o=n.n(i),r={"~x(":"at-wits-end.gif","x(":"angry-or-grumpy.gif",";;)":"batting-eyelashes.gif",">:d<":"big-hug.gif",'=">':"blushing.gif","=((":"broken-heart.gif",":-/":"confused.gif","b-)":"sunglasses-or-cool.gif",":((":"crying.gif","8->":"daydreaming.gif",">:)":"devil.gif",":-$":"do-not-tell-anyone.gif","#-o":"doh!.gif","=p~":"drooling.gif",x_x:"i-do-not-want-to-see.gif",":-*":"kiss.gif",":))":"laughing.gif",":x":"love-struck.gif",":-ss":"nail-biting.gif",":-b":"nerd.gif","[-(":"not-talking.gif",":)]":"on-the-phone.gif","<:-p":"party.gif",">:p":"phbbbbt-or-upset.gif","/:)":"raised-eyebrow.gif","8-|":"rolling-eyes.gif",":-w":"waiting.gif",":-h":"wave.gif","#:-s":"whew.gif",";)":"winking.gif",":-s":"worried.gif","(:|":"yawn.gif",">-)":"alien.gif","b-(":"beat-up.gif",":-@":"chatterbox.gif",":-??":"confused-or-i-don't-know.gif","\\:d/":"dancing.gif",":-l":"frustrated.gif",";))":"giggle-or-hee-hee.gif","%-(":"not-listening.gif",':-"':"whistling.gif",":(":"sad-or-frown-face.gif","=))":"rolling-on-the-floor-laughing.gif",":&":"sick.gif",":-<":"sigh.gif","|-)":"sleepy.gif",":)":"smile-or-happy-face.gif",":>":"smug.gif",":p":"frustrated-or-sticking-tongue-out.gif",":|":"straight-face.gif",":o":"surprised.gif",":-?":"thinking.gif",":d":"big-grin.gif"},s=Object.keys(r),a=function(e){for(var t=e||"",n=0;n<s.length;n++)for(var i=s[n],a=r[i],c=o()(i),u='<img src="/emoticons/'.concat(a,'" />');t.includes(c);)t=t.replace(c,u);return t}},74:function(e,t){}}]);